<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creatividad Impresa | Sublimación y Estampados Profesionales</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librería para Captura de pantalla (Capturar el diseño final) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Carga de Leaflet CSS (Requerido para el mapa de OpenStreetMap) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha2d14-rK4vR1j4z3wGv29609fT5z3x0m8wQx4g6g7L1T8F70E7J6z7J7z9x5c5Q=="
          crossorigin=""/>
    
    <!-- Configuración para usar la fuente Inter y un esquema de color personalizado -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Paleta de Celeste Pastel
                        'primary': '#4FC3F7', // Celeste Vívido (Para botones y acentos fuertes)
                        'secondary': '#FFD54F', // Amarillo Suave (Contraste cálido)
                        'dark-bg': '#263238', // Gris Azulado Oscuro (Fondo de sección)
                    },
                    // Definición de animaciones y keyframes
                    keyframes: {
                        pulseShadow: {
                            '0%, 100%': { boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1)' },
                            '50%': { boxShadow: '0 10px 15px -3px rgba(79, 195, 247, 0.5), 0 4px 6px -4px rgba(79, 195, 247, 0.5)' },
                        },
                        subtlePulse: {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(1.02)' },
                        }
                    },
                    animation: {
                        'pulse-shadow': 'pulseShadow 2s infinite ease-in-out',
                        'subtle-pulse': 'subtlePulse 4s infinite ease-in-out',
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* Estilos personalizados */
        .input-focus:focus {
            box-shadow: 0 0 0 2px #4FC3F7; /* Anillo de enfoque primario (Celeste) */
        }
        
        /* Estilo necesario para que Leaflet funcione correctamente */
        #contactMap {
            width: 100%;
            height: 100%;
        }

        /* Habilitar la interacción directa para el arrastre y zoom */
        #designOverlay {
            pointer-events: auto; /* Permite arrastrar y hacer zoom */
            cursor: grab;
            touch-action: none; /* Previene el comportamiento por defecto del scroll/zoom del navegador en móvil */
            transition: all 0.1s linear; /* Animación para un ajuste más suave */
        }
        #designOverlay:active {
            cursor: grabbing;
        }

        #customizerModal::-webkit-scrollbar {
            width: 8px;
        }

        #customizerModal::-webkit-scrollbar-thumb {
            background-color: #4FC3F7;
            border-radius: 10px;
        }
        
        /* Contenedor forzando un aspecto 1:1 para los placeholders de color */
        .product-base {
            width: 100%;
            position: relative; 
            border-radius: 0.75rem; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 4px solid #f9fafb;
        }

        /* Clase para Camisetas (ej. 4:5 - más vertical) */
        .aspect-ratio-portrait {
            padding-top: 125%; 
        }

        /* Clase para Tazas (ej. 1:1 - cuadrada) */
        .aspect-ratio-square {
            padding-top: 100%; 
        }

        .product-base-inner {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            border-radius: 0.5rem; 
        }
        
        /* Asegurar que el contenedor del diseño no se mueva con el scroll/zoom del navegador */
        #previewBox {
            max-width: 350px; 
            min-height: 400px;
        }
        
        .hidden-file-input {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }

        /* Animación de apertura del modal */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-open-animation {
            animation: fadeIn 0.4s ease-out forwards;
        }

        /* Estilo para el efecto de sombra del botón de WhatsApp */
        .whatsapp-button:hover {
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.8);
            transform: scale(1.05); /* Ligeramente más grande */
        }
    </style>
</head>

<body class="font-sans text-gray-800 bg-gray-50 antialiased">

    <!-- Navbar - Fondo oscuro para el estilo del logo -->
    <header class="sticky top-0 z-50 bg-dark-bg shadow-lg">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <!-- LOGO CON ANIMACIÓN AL HOVER -->
            <a href="#" class="text-3xl font-extrabold tracking-tight flex items-center hover:scale-[1.03] transition duration-300">
                <span class="text-white">Atelier</span>
                <span class="text-primary ml-2 hover:text-secondary transition duration-300">Print</span>
            </a>
            <div class="hidden md:flex space-x-8">
                <a href="#inicio" class="text-gray-200 hover:text-primary transition duration-300 font-medium hover:scale-105">Inicio</a>
                <a href="#servicios" class="text-gray-200 hover:text-primary transition duration-300 font-medium hover:scale-105">Servicios</a>
                <a href="#" onclick="openCustomizer(event)" class="text-gray-200 hover:text-primary transition duration-300 font-medium hover:scale-105">Diseña Ahora</a>
                <a href="#galeria" class="text-gray-200 hover:text-primary transition duration-300 font-medium hover:scale-105">Galería</a>
                <a href="#contacto" class="text-dark-bg bg-secondary py-2 px-4 rounded-full hover:bg-yellow-300 transition duration-300 font-medium shadow-lg hover:shadow-xl hover:scale-105">Contacto</a>
            </div>
            <button class="md:hidden p-2 text-primary hover:text-sky-600 transition duration-300 rounded-lg font-bold">
                Menú
            </button>
        </nav>
    </header>

    <main>
        <!-- Sección Hero (Inicio) -->
        <section id="inicio" class="relative bg-dark-bg text-white pt-20 pb-28 md:pt-32 md:pb-40 overflow-hidden">
            <div class="absolute inset-0 opacity-10 bg-repeat" style="background-image: linear-gradient(45deg, rgba(79, 195, 247, 0.1) 25%, transparent 25%, transparent 75%, rgba(79, 195, 247, 0.1) 75%, rgba(79, 195, 247, 0.1)); background-size: 50px 50px;"></div>

            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10 flex flex-col md:flex-row items-center">
                <div class="md:w-1/2 text-center md:text-left mb-10 md:mb-0">
                    <h1 class="text-5xl md:text-6xl font-extrabold leading-tight mb-4 tracking-tighter">
                        Tu Idea, <span class="text-secondary block md:inline">Nuestra Estampa.</span>
                    </h1>
                    <p class="text-xl text-gray-300 mb-8 max-w-lg mx-auto md:mx-0">
                        Convertimos tus diseños en productos memorables. Expertos en sublimación de alta definición y estampados duraderos.
                    </p>
                    <a href="#" onclick="openCustomizer(event)" class="inline-block bg-secondary text-dark-bg font-bold py-3 px-8 rounded-full text-lg hover:bg-yellow-300 transition duration-300 transform hover:scale-105 shadow-xl animate-pulse-shadow">
                        Empieza a Diseñar
                    </a>
                </div>
                <div class="md:w-1/2 flex justify-center">
                    <div class="w-64 h-64 md:w-96 md:h-96 rounded-3xl shadow-2xl transform rotate-3 hover:rotate-0 transition duration-500 ease-in-out border-4 border-secondary/50 max-w-full flex items-center justify-center bg-primary text-dark-bg text-2xl font-bold animate-subtle-pulse">
                        Tu Diseño Aquí
                    </div>
                </div>
            </div>
        </section>

        <!-- Sección de Servicios -->
        <section id="servicios" class="py-20 bg-white">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <h2 class="text-4xl font-bold text-gray-900 mb-4">Nuestros Servicios Clave</h2>
                <p class="text-xl text-gray-600 mb-12">Calidad, color y precisión en cada técnica que dominamos.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
                    <!-- TARJETA 1 con animación de elevación sutil -->
                    <div class="bg-white p-8 rounded-2xl shadow-xl hover:shadow-2xl transition duration-500 transform hover:-translate-y-2 border-t-4 border-primary/50">
                        <h3 class="text-2xl font-semibold mb-3 pt-4">Sublimación de Alta Definición</h3>
                        <p class="text-gray-600">Ideal para textiles de poliéster y productos promocionales. Colores vibrantes, permanentes y que no se sienten al tacto. Perfecto para diseños complejos.</p>
                    </div>
                    <!-- TARJETA 2 con animación de elevación sutil -->
                    <div class="bg-white p-8 rounded-2xl shadow-xl hover:shadow-2xl transition duration-500 transform hover:-translate-y-2 border-t-4 border-primary/50">
                        <h3 class="text-2xl font-semibold mb-3 pt-4">Estampado con Vinilo Termotransferible</h3>
                        <p class="text-gray-600">Acabados con textura, efectos especiales (glitter, metálicos) y gran opacidad. Excelente para algodón y prendas de trabajo o deportivas de alta resistencia.</p>
                    </div>
                    <!-- TARJETA 3 con animación de elevación sutil -->
                    <div class="bg-white p-8 rounded-2xl shadow-xl hover:shadow-2xl transition duration-500 transform hover:-translate-y-2 border-t-4 border-primary/50">
                        <h3 class="text-2xl font-semibold mb-3 pt-4">Asesoría y Diseño Gráfico</h3>
                        <p class="text-gray-600">¿No tienes el diseño listo? Nuestro equipo te asesora o crea el arte final desde cero, garantizando que el resultado impreso sea perfecto y listo para producción.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sección de Galería/Portfolio -->
        <section id="galeria" class="py-20 bg-gray-100">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <h2 class="text-4xl font-bold text-gray-900 mb-4">Proyectos que Nos Inspiran</h2>
                <p class="text-xl text-gray-600 mb-12">Mira la calidad y el detalle que ponemos en cada pedido.</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="relative group overflow-hidden rounded-xl shadow-lg hover:shadow-2xl transition duration-300 transform hover:scale-[1.02] bg-primary h-64 flex items-center justify-center">
                        <div class="absolute inset-0 bg-primary/70 opacity-100 flex items-center justify-center">
                            <p class="text-white text-xl font-bold">Tazas Premium</p>
                        </div>
                    </div>
                    <div class="relative group overflow-hidden rounded-xl shadow-lg hover:shadow-2xl transition duration-300 transform hover:scale-[1.02] bg-secondary h-64 flex items-center justify-center">
                        <div class="absolute inset-0 bg-secondary/70 opacity-100 flex items-center justify-center">
                            <p class="text-dark-bg text-xl font-bold">Remeras Full Color</p>
                        </div>
                    </div>
                    <div class="relative group overflow-hidden rounded-xl shadow-lg hover:shadow-2xl transition duration-300 transform hover:scale-[1.02] bg-blue-500 h-64 flex items-center justify-center">
                        <div class="absolute inset-0 bg-blue-500/70 opacity-100 flex items-center justify-center">
                            <p class="text-white text-xl font-bold">Gorras de Marca</p>
                        </div>
                    </div>
                    <div class="relative group overflow-hidden rounded-xl shadow-lg hover:shadow-2xl transition duration-300 transform hover:scale-[1.02] bg-emerald-500 h-64 flex items-center justify-center">
                        <div class="absolute inset-0 bg-emerald-500/70 opacity-100 flex items-center justify-center">
                            <p class="text-white text-xl font-bold">Merchandising</p>
                        </div>
                    </div>
                </div>
                <a href="#contacto" onclick="closeCustomizer()" class="mt-12 inline-block text-lg font-semibold text-primary hover:text-sky-600 transition duration-300 border-b-2 border-primary hover:border-sky-600 hover:scale-105">Ver más trabajos →</a>
            </div>
        </section>

        <!-- Sección de Ubicación y Contacto con MAPA FUNCIONAL -->
        <section id="ubicacion" class="py-20 bg-gray-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <h2 class="text-4xl font-bold text-gray-900 mb-4">Encuéntranos en Tarragona</h2>
                <p class="text-xl text-gray-600 mb-8">Estamos cerca de la histórica Tarraco Arena (Antigua Plaza de Toros).</p>
                
                <!-- CONTENEDOR DEL MAPA (ID: contactMap) -->
                <div id="contactMap" class="rounded-2xl overflow-hidden shadow-2xl border-4 border-primary w-full max-w-4xl mx-auto" style="height: 400px;">
                    <!-- El mapa interactivo de Leaflet se cargará aquí al iniciar JS -->
                    <div class="w-full h-full flex items-center justify-center bg-gray-200/50 p-8 text-center">
                        <div class="text-gray-700">Cargando Mapa...</div>
                    </div>
                </div>

            </div>
        </section>

        <!-- Sección de Contacto -->
        <section id="contacto" class="py-20 bg-dark-bg text-white">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-12">
                    <h2 class="text-4xl font-bold text-white mb-4">¡Empecemos tu Proyecto!</h2>
                    <p class="text-xl text-gray-300">Cuéntanos tu idea. Te responderemos con una cotización detallada en menos de 24 horas.</p>
                    
                    <!-- BOTÓN DE WHATSAPP con el icono de usuario y ANIMACIÓN PULSADA -->
                    <a href="https://wa.me/5491100000000?text=Hola,%20me%20interesa%20una%20cotización%20de%20sublimación." target="_blank" class="whatsapp-button inline-flex items-center justify-center mt-6 mb-10 bg-green-500 text-white font-bold py-3 px-8 rounded-full text-lg transition duration-300 transform hover:scale-105 shadow-xl hover:bg-green-600">
                        <img src="whatsapp_icon.png" alt="Icono de WhatsApp" class="w-6 h-6 mr-3">
                        Contactar Directo por WhatsApp
                    </a>
                </div>

                <div class="bg-white p-8 md:p-10 rounded-2xl shadow-2xl">
                    <!-- FORMULARIO REAL CONECTADO A FORMSUBMIT -->
                    <form id="contactForm" action="https://formsubmit.co/ellsanty123@gmail.com" method="POST" class="space-y-6" onsubmit="return submitFormWithDesign(event)">
                        
                        <!-- Campo oculto para definir el asunto del email -->
                        <input type="hidden" name="_subject" value="Nueva Solicitud de Cotización (Atelier Print)">
                        
                        <!-- CAMPO OCULTO PARA LA IMAGEN DEL DISEÑO (Base64) -->
                        <input type="hidden" name="design_image_url" id="designImageUrl">
                        
                        <!-- Campos de Producto y Talle/Color seleccionados (Para facilitar la cotización) -->
                        <input type="hidden" name="selected_product" id="selectedProductInput">
                        <input type="hidden" name="selected_size_color" id="selectedSizeColorInput">

                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo</label>
                            <input type="text" id="name" name="name" required class="input-focus mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg text-gray-900 placeholder-gray-400 transition duration-150">
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label>
                            <input type="email" id="email" name="email" required class="input-focus mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg text-gray-900 placeholder-gray-400 transition duration-150">
                        </div>
                        <div>
                            <label for="message" class="block text-sm font-medium text-gray-700 mb-1">Detalles del Proyecto (Cantidad, Tipo de Producto, Diseño)</label>
                            <textarea id="message" name="message" rows="4" required class="input-focus mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg text-gray-900 placeholder-gray-400 transition duration-150"></textarea>
                        </div>
                        <button type="submit" id="submitButton" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg hover:bg-sky-600 transition duration-300 transform hover:scale-[1.01] shadow-lg hover:shadow-xl">
                            Enviar Solicitud de Cotización
                        </button>
                    </form>
                    <div id="loadingStatus" class="mt-4 text-center text-primary font-semibold hidden">
                        Generando vista previa del diseño... por favor, espera un momento.
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- MODAL DEL PERSONALIZADOR (Fuera de <main> y oculto) -->
    <div id="customizerModal" class="fixed inset-0 z-[100] bg-dark-bg/95 backdrop-blur-sm hidden overflow-y-auto transition-opacity duration-300 opacity-0">
        <div class="max-w-7xl mx-auto py-10 px-4 sm:px-6 lg:px-8">
            <div class="bg-gray-50 p-6 md:p-8 rounded-3xl shadow-2xl relative modal-content-animation">
                
                <!-- Botón de Cierre -->
                <button onclick="closeCustomizer()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-900 transition duration-300 p-2 rounded-full bg-white shadow-lg z-20 hover:scale-110">
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-circle"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
                </button>

                <div class="text-center">
                    <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">Diseña tu Producto al Instante</h2>
                    <p class="text-lg md:text-xl text-gray-600 mb-8">Arrastra, pellizca o usa la rueda para ajustar tu diseño.</p>
                </div>

                <!-- Contenedor Responsive: Vista Previa arriba en móvil, Controles abajo -->
                <div class="flex flex-col lg:flex-row gap-8 lg:gap-12 items-start max-w-5xl mx-auto">
                    
                    <!-- Columna de Vista Previa (3/5 en desktop, 1/1 en mobile - orden 1) -->
                    <div class="lg:w-3/5 w-full order-1 lg:order-2 bg-white p-4 md:p-6 rounded-2xl shadow-xl flex justify-center items-center">
                        <div id="previewBox" class="relative w-full mx-auto max-w-sm transition-all duration-300 bg-gray-100 rounded-xl p-4 shadow-inner">
                            <div id="productBaseContainer" class="product-base aspect-ratio-portrait bg-white">
                                <!-- IMAGEN BASE (MOCKUP) CON RUTA RELATIVA: './images/camiseta_blanca.jpg' -->
                                <img id="baseProductImage" 
                                    src="camiseta_blanca.jpg" 
                                    alt="Camiseta Blanca Personalizada" 
                                    class="product-base-inner w-full h-full object-cover transition-opacity duration-300"
                                >
                                
                                <!-- Placeholder de Color (Solo visible si no hay imagen de mockup o si falla la carga) -->
                                <div id="baseColorPlaceholder" class="product-base-inner hidden bg-gray-50">
                                    <div class="product-base-inner">
                                        <!-- Icono Lucide para un mockup genérico -->
                                        <svg xmlns="http://www.w3.org/2000/svg" id="productMockupIcon" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shirt mb-2 text-gray-400"><path d="M20.3 3.3a2 2 0 0 0-2.6.4l-4.2 3.8L9 3.7c-.5-.4-1-.7-1.7-.7s-1.2.3-1.7.7L2.3 8.2a2 2 0 0 0-.4 2.6l4.2 3.8V21a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-6.4l4.2-3.8a2 2 0 0 0-.4-2.6z"/></svg>
                                        <p class="text-xl font-bold"></p>
                                        <p class="text-sm">(Mockup Color)</p>
                                    </div>
                                </div>
                                
                                <!-- Capa de Diseño (Overlay) -->
                                <img id="designOverlay" src="" alt="Tu Diseño de Sublimación" 
                                    class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 transition-all duration-100 ease-linear opacity-0 z-10" 
                                    style="width: 150px; height: auto; user-select: none;"
                                >
                                
                                <!-- Mensaje para subir diseño -->
                                <div id="designPrompt" class="absolute inset-0 flex items-center justify-center text-gray-400 font-semibold bg-white/70 rounded-xl transition duration-300">
                                    Sube un diseño para verlo aquí
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Columna de Controles (2/5 en desktop, 1/1 en mobile - orden 2) -->
                    <div class="lg:w-2/5 w-full order-2 lg:order-1 bg-white p-6 md:p-8 rounded-2xl shadow-xl border border-gray-200 text-left">
                        
                        <!-- 1. Producto y Color -->
                        <h3 class="text-2xl font-semibold mb-4 text-gray-900">1. Producto y Color</h3>
                        
                        <!-- Selector de Producto -->
                        <label class="block text-gray-700 font-medium mb-2">Selecciona el Producto</label>
                        <div class="flex space-x-4 mb-6">
                            <label class="inline-flex items-center">
                                <input type="radio" name="productType" value="Camiseta" checked onchange="updateProductView()" class="form-radio text-primary h-5 w-5 border-gray-300 focus:ring-primary rounded-full">
                                <span class="ml-2 text-gray-700 font-medium">Camiseta</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="productType" value="Taza" onchange="updateProductView()" class="form-radio text-primary h-5 w-5 border-gray-300 focus:ring-primary rounded-full">
                                <span class="ml-2 text-gray-700 font-medium">Taza</span>
                            </label>
                        </div>

                        <!-- Selector de Color -->
                        <label class="block text-gray-700 font-medium mb-2">Selecciona el Color</label>
                        <div class="flex space-x-4 mb-6">
                            <label class="inline-flex items-center">
                                <input type="radio" id="colorWhite" name="productColor" value="Blanca" checked onchange="updateProductView()" class="form-radio text-primary h-5 w-5 border-gray-300 focus:ring-primary rounded-full">
                                <span class="ml-2 text-gray-700 font-medium">Blanco</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" id="colorBlack" name="productColor" value="Negra" onchange="updateProductView()" class="form-radio text-primary h-5 w-5 border-gray-300 focus:ring-primary rounded-full">
                                <span class="ml-2 text-gray-700 font-medium">Negro</span>
                            </label>
                        </div>

                        <!-- 2. Sube tu Diseño -->
                        <h3 class="text-2xl font-semibold mt-8 mb-4 text-gray-900">2. Sube y Ajusta</h3>
                        
                        <input type="file" id="designUpload" accept="image/*" class="hidden-file-input">
                        
                        <label for="designUpload" class="w-full inline-flex items-center justify-center bg-primary text-white font-bold py-3 px-4 rounded-lg hover:bg-sky-600 transition duration-300 shadow-md cursor-pointer hover:scale-[1.01]">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-upload mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                            Seleccionar Archivo de Imagen
                        </label>

                        <p id="uploadStatus" class="mt-4 text-sm text-gray-500 hidden"></p>

                        <!-- Mensaje de instrucción de interacción táctil -->
                        <div id="interactionGuide" class="mt-4 p-3 bg-primary/10 border border-primary/30 rounded-lg text-sm text-gray-700 font-medium hidden">
                            <p class="font-bold text-primary mb-1">¡Consejo de Diseño!</p>
                            <ul class="list-disc list-inside space-y-1">
                                <li>**Móvil:** Arrastra con un dedo para mover. Pellizca con dos dedos para cambiar tamaño.</li>
                                <li>**Desktop:** Arrastra con el ratón. Usa la rueda para cambiar tamaño.</li>
                            </ul>
                        </div>
                        
                        <!-- 4. Talle (Condicional) -->
                        <div id="shirtSizeSelector" class="transition-all duration-300 ease-in-out overflow-hidden mt-8 max-h-[500px]">
                            <h3 class="text-2xl font-semibold mb-4 text-gray-900">3. Selecciona Talle</h3>
                            <div class="space-y-4">
                                <label for="shirtSize" class="block text-gray-700 font-medium mb-1">Talle de Camiseta</label>
                                <select id="shirtSize" class="w-full border border-gray-300 rounded-lg p-3 text-gray-700 bg-gray-50 input-focus transition duration-150">
                                    <option value="Talle S">S - Small</option>
                                    <option value="Talle M" selected>M - Medium</option>
                                    <option value="Talle L">L - Large</option>
                                    <option value="Talle XL">XL - Extra Large</option>
                                </select>
                                
                                <button onclick="toggleSizeGuide()" class="text-sm font-medium text-primary hover:text-sky-600 transition duration-300 flex items-center mt-2 hover:scale-105">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-ruler mr-1"><path d="M20 7H4"/><path d="M10 3v4"/><path d="M14 3v4"/><path d="M16 11H8"/><path d="M12 7v14"/></svg>
                                    <span id="guideToggleButton">Ver Guía de Talles (Cerrar)</span>
                                </button>
                            </div>
                            
                            <div id="sizeGuideTable" class="mt-6 p-0 border border-gray-300 rounded-lg bg-gray-50 overflow-hidden transition-all duration-300 ease-in-out max-h-fit">
                                <div class="p-4">
                                    <h4 class="text-lg font-bold mb-3 text-gray-800">Guía de Talles (Medidas en cm)</h4>
                                    <table class="w-full text-sm text-gray-700 text-left">
                                        <thead class="border-b border-gray-200">
                                            <tr>
                                                <th class="py-1 pr-2">Talle</th>
                                                <th class="py-1 px-2">Ancho (Pecho)</th>
                                                <th class="py-1 pl-2">Largo (Espalda)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr class="border-b border-gray-100">
                                                <td class="py-1 pr-2 font-semibold">S</td>
                                                <td class="py-1 px-2">48 cm</td>
                                                <td class="py-1 pl-2">68 cm</td>
                                            </tr>
                                            <tr class="border-b border-gray-100">
                                                <td class="py-1 px-2 font-semibold">M</td>
                                                <td class="py-1 pl-2">51 cm</td>
                                                <td class="py-1 pl-2">71 cm</td>
                                            </tr>
                                            <tr class="border-b border-gray-100">
                                                <td class="py-1 pr-2 font-semibold">L</td>
                                                <td class="py-1 px-2">54 cm</td>
                                                <td class="py-1 pl-2">74 cm</td>
                                            </tr>
                                            <tr>
                                                <td class="py-1 pr-2 font-semibold">XL</td>
                                                <td class="py-1 px-2">57 cm</td>
                                                <td class="py-1 pl-2">77 cm</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <p class="text-xs mt-3 text-gray-500">Nota: El ancho se mide de axila a axila. Tolerancia de $\pm 2$ cm.</p>
                                </div>
                            </div>
                        </div>

                        <button onclick="resetDesign()" class="mt-8 w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 transition duration-300 shadow-md hover:scale-[1.01]">
                            Reiniciar Diseño
                        </button>
                    </div>
                </div>
                
                <!-- Call to action después del diseño -->
                <div class="mt-12 text-center">
                    <a href="#contacto" onclick="closeCustomizer()" class="inline-block bg-primary text-white font-bold py-3 px-10 rounded-full text-lg hover:bg-sky-600 transition duration-300 transform hover:scale-105 shadow-xl animate-pulse-shadow">
                        ¡Me gusta! Quiero Cotizar este Diseño
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Carga de Leaflet JavaScript (Va antes de tu script principal) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha2d14-AHzjU/pMhS00sC9PjG3j0x1F2B1r8hV5x5w9u2p4e0T3J4I5L6S4X9J3p9M8X7N7S0Y3D2L5T9W3M4A9V5"
            crossorigin=""></script>

    <!-- JavaScript para el Formulario y el Personalizador -->
    <script>
        // --- LÓGICA DEL PERSONALIZADOR ---
        const designUpload = document.getElementById('designUpload');
        const designOverlay = document.getElementById('designOverlay');
        const designPrompt = document.getElementById('designPrompt');
        const uploadStatus = document.getElementById('uploadStatus');
        const interactionGuide = document.getElementById('interactionGuide');
        
        const sizeGuideTable = document.getElementById('sizeGuideTable');
        const guideToggleButton = document.getElementById('guideToggleButton');
        const shirtSizeSelector = document.getElementById('shirtSizeSelector');
        
        const baseProductImage = document.getElementById('baseProductImage');
        const baseColorPlaceholder = document.getElementById('baseColorPlaceholder');
        const productBaseContainer = document.getElementById('productBaseContainer');
        const previewBox = document.getElementById('previewBox');

        // Referencias del formulario
        const contactForm = document.getElementById('contactForm');
        const designImageUrlInput = document.getElementById('designImageUrl');
        const selectedProductInput = document.getElementById('selectedProductInput');
        const selectedSizeColorInput = document.getElementById('selectedSizeColorInput');
        const submitButton = document.getElementById('submitButton');
        const loadingStatus = document.getElementById('loadingStatus');

        // Definición de Mockups de Producto con rutas relativas
        const PRODUCT_MOCKUPS = {
            // Se asume que 'camiseta_blanca.jpg' ha sido cargado en el entorno
            'Camiseta-Blanca': { 
                url: 'camiseta_blanca.jpg', // Ruta de la imagen subida o disponible
                type: 'Camiseta', 
                name: 'Camiseta Blanca' 
            },
            // Si no hay mockup físico, usamos un color plano (background-color)
            'Camiseta-Negra': { 
                url: '', 
                type: 'Camiseta', 
                name: 'Camiseta Negra' 
            }, 
            'Taza-Blanca': { 
                url: '', 
                type: 'Taza', 
                name: 'Taza Blanca' 
            }, 
            'Taza-Negra': { 
                url: '', 
                type: 'Taza', 
                name: 'Taza Negra' 
            }
        };

        // Estado inicial de la superposición del diseño (AHORA DINÁMICO)
        let designState = {
            x: 0, 
            y: 0, 
            scale: 1, 
            designUrl: '',
            isDragging: false,
            initialTouchDistance: null, 
            lastX: 0,
            lastY: 0,
        };
        
        // Área de impresión segura (SAFE_ZONE): 10% de margen a cada lado.
        const SAFE_ZONE = 0.1; 

        // Función para aplicar la transformación al overlay
        function applyDesignTransform() {
            const baseDesignWidth = 150; 
            const newWidth = baseDesignWidth * designState.scale;
            designOverlay.style.width = `${newWidth}px`;
            designOverlay.style.height = `auto`; 
            designOverlay.style.transform = `translate(-50%, -50%) translate(${designState.x}px, ${designState.y}px)`;
        }
        
        // Función para limitar el movimiento del diseño dentro del área segura
        function clampDesignPosition() {
            // Solo limitar si hay un diseño cargado
            if (!designState.designUrl) return;

            const containerRect = productBaseContainer.getBoundingClientRect();
            const containerWidth = productBaseContainer.offsetWidth; // Usar offsetWidth para el tamaño actual
            const containerHeight = productBaseContainer.offsetHeight; // Usar offsetHeight

            // Forzar reflow para obtener dimensiones correctas
            const designWidth = designOverlay.offsetWidth;
            const designHeight = designOverlay.offsetHeight;

            const safeXMargin = containerWidth * SAFE_ZONE;
            const safeYMargin = containerHeight * SAFE_ZONE;
            
            const centerX = containerWidth / 2;
            const centerY = containerHeight / 2;

            // Calcular límites de movimiento (la posición 'x' y 'y' son relativas al centro del contenedor)
            // Límite máximo positivo: (Centro del Contenedor - Margen de Zona Segura) - (Mitad del Diseño)
            const maxX = (centerX - safeXMargin) - (designWidth / 2);
            const minX = -maxX;
            const maxY = (centerY - safeYMargin) - (designHeight / 2);
            const minY = -maxY;

            // Aplicar clamping al movimiento
            designState.x = Math.min(Math.max(designState.x, minX), maxX);
            designState.y = Math.min(Math.max(designState.y, minY), maxY);

            // Asegurar un zoom mínimo
            designState.scale = Math.max(designState.scale, 0.5); 
            
            // Si el diseño es más grande que el área segura, forzar al centro (para evitar que se salga)
            // Solo se hace si el diseño ES visible
            if (designOverlay.classList.contains('opacity-0') === false) {
                 if (designWidth > containerWidth * (1 - 2 * SAFE_ZONE) || designHeight > containerHeight * (1 - 2 * SAFE_ZONE)) {
                    designState.x = 0;
                    designState.y = 0;
                }
            }
           

            applyDesignTransform();
        }

        // --- LÓGICA DE INTERACCIÓN (Arrastrar y Escalar) ---

        function getDistance(touches) {
            return Math.sqrt(
                Math.pow(touches[0].pageX - touches[1].pageX, 2) +
                Math.pow(touches[0].pageY - touches[1].pageY, 2)
            );
        }

        designOverlay.addEventListener('mousedown', startDrag);
        designOverlay.addEventListener('touchstart', startDrag, { passive: false });

        function startDrag(e) {
            e.preventDefault();
            if (!designState.designUrl) return;

            designState.isDragging = true;
            
            if (e.touches && e.touches.length > 0) {
                if (e.touches.length === 1) {
                    designState.lastX = e.touches[0].clientX;
                    designState.lastY = e.touches[0].clientY;
                    designState.initialTouchDistance = null; 
                } else if (e.touches.length >= 2) {
                    designState.initialTouchDistance = getDistance(e.touches);
                    designState.lastScale = designState.scale;
                    designState.isDragging = false; 
                }
            } else {
                designState.lastX = e.clientX;
                designState.lastY = e.clientY;
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', endDrag);
            }
        }
        
        designOverlay.addEventListener('touchmove', drag, { passive: false });

        function drag(e) {
            if (!designState.designUrl) return;
            e.preventDefault(); 

            if (e.touches && e.touches.length > 0) {
                if (e.touches.length === 1 && designState.isDragging) {
                    const deltaX = e.touches[0].clientX - designState.lastX;
                    const deltaY = e.touches[0].clientY - designState.lastY;

                    designState.x += deltaX;
                    designState.y += deltaY;

                    designState.lastX = e.touches[0].clientX;
                    designState.lastY = e.touches[0].clientY;
                } else if (e.touches.length >= 2 && designState.initialTouchDistance !== null) {
                    const currentDistance = getDistance(e.touches);
                    const scaleFactor = currentDistance / designState.initialTouchDistance;
                    designState.scale = designState.lastScale * scaleFactor;
                }
            } else if (designState.isDragging) {
                const deltaX = e.clientX - designState.lastX;
                const deltaY = e.clientY - designState.lastY;

                designState.x += deltaX;
                designState.y += deltaY;

                designState.lastX = e.clientX;
                designState.lastY = e.clientY;
            }
            
            clampDesignPosition();
        }

        designOverlay.addEventListener('touchend', endDrag);

        function endDrag(e) {
            designState.isDragging = false;
            designState.initialTouchDistance = null;
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', endDrag);
            clampDesignPosition();
        }

        designOverlay.addEventListener('wheel', function(e) {
            if (!designState.designUrl) return;
            e.preventDefault(); 

            const zoomAmount = e.deltaY > 0 ? -0.1 : 0.1; 
            designState.scale += zoomAmount;
            
            clampDesignPosition(); 
        });

        // --- FUNCIONES DEL MODAL Y VISTA ---

        function openCustomizer(event) {
            if (event) event.preventDefault();
            const modal = document.getElementById('customizerModal');
            modal.classList.remove('hidden');
            // Aplicar la animación de entrada
            modal.querySelector('.bg-gray-50').classList.add('modal-open-animation');
            setTimeout(() => modal.classList.add('opacity-100'), 10);
            updateProductView(); 
        }

        function closeCustomizer() {
            const modal = document.getElementById('customizerModal');
            modal.classList.remove('opacity-100');
            modal.querySelector('.bg-gray-50').classList.remove('modal-open-animation');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function updateProductView() {
            const productType = document.querySelector('input[name="productType"]:checked').value;
            const productColor = document.querySelector('input[name="productColor"]:checked').value;
            const key = `${productType}-${productColor}`;
            const product = PRODUCT_MOCKUPS[key];
            const isShirt = productType === 'Camiseta';

            // 1. Alternar Controles Específicos
            shirtSizeSelector.style.maxHeight = isShirt ? '500px' : '0';
            shirtSizeSelector.style.paddingTop = isShirt ? '2rem' : '0';
            shirtSizeSelector.style.borderTop = isShirt ? '1px solid #e5e7eb' : 'none';
            shirtSizeSelector.style.marginBottom = isShirt ? '1rem' : '0'; // Ajustar margen

            // 2. Actualizar Mockup de Producto Base
            productBaseContainer.classList.toggle('aspect-ratio-portrait', isShirt);
            productBaseContainer.classList.toggle('aspect-ratio-square', !isShirt);

            // Intentar usar la imagen del mockup si existe, si no, usa el placeholder de color
            baseProductImage.src = product.url || '';
            
            if (!product.url) {
                // Si no hay URL, oculta la imagen y muestra el placeholder
                baseProductImage.style.display = 'none';
                baseColorPlaceholder.classList.remove('hidden');
            } else {
                // Si hay URL, muestra la imagen y oculta el placeholder
                baseProductImage.style.display = 'block';
                baseColorPlaceholder.classList.add('hidden');
            }
            
            productBaseContainer.style.backgroundColor = 'transparent';

            if (!product.url) {
                // Configurar colores del placeholder
                if (productColor === 'Blanca') {
                    productBaseContainer.style.backgroundColor = '#f9fafb'; 
                    document.getElementById('productMockupIcon').classList.remove('text-gray-200');
                    document.getElementById('productMockupIcon').classList.add('text-gray-400');
                    baseColorPlaceholder.querySelector('p:first-child').classList.remove('text-gray-200');
                    baseColorPlaceholder.querySelector('p:first-child').classList.add('text-gray-800');
                } else if (productColor === 'Negra') {
                    productBaseContainer.style.backgroundColor = '#4b5563'; 
                    document.getElementById('productMockupIcon').classList.remove('text-gray-400');
                    document.getElementById('productMockupIcon').classList.add('text-gray-200');
                    baseColorPlaceholder.querySelector('p:first-child').classList.remove('text-gray-800');
                    baseColorPlaceholder.querySelector('p:first-child').classList.add('text-gray-200');
                }

                baseColorPlaceholder.querySelector('p:first-child').textContent = product.name;

                // Actualizar icono Lucide para que coincida con el producto
                const svg = document.getElementById('productMockupIcon');
                const iconClass = isShirt ? 'lucide lucide-shirt' : 'lucide lucide-coffee';
                const iconPath = isShirt ? '<path d="M20.3 3.3a2 2 0 0 0-2.6.4l-4.2 3.8L9 3.7c-.5-.4-1-.7-1.7-.7s-1.2.3-1.7.7L2.3 8.2a2 2 0 0 0-.4 2.6l4.2 3.8V21a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-6.4l4.2-3.8a2 2 0 0 0-.4-2.6z"/>' : '<path d="M10 2v2"/><path d="M14 2v2"/><path d="M8 21h8"/><path d="M8 21a2 2 0 0 1-2-2v-3H4a2 2 0 0 1-2-2V7h20v7a2 2 0 0 1-2 2h-2v3a2 2 0 0 1-2 2z"/><path d="M16 16v-3a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2v3"/>';
                svg.innerHTML = iconPath;
                svg.className.baseVal = iconClass + ' mb-2 text-gray-400';
            }

            // 3. Ajustar Overlay de Diseño (posición)
            clampDesignPosition();
        }

        // Función para manejar la subida de la imagen del diseño
        designUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    designState.designUrl = event.target.result;
                    designState.x = 0; 
                    designState.y = 0; 
                    designState.scale = 1; 

                    designOverlay.src = designState.designUrl;
                    designOverlay.classList.remove('opacity-0');
                    designPrompt.classList.add('hidden');
                    interactionGuide.classList.remove('hidden');

                    clampDesignPosition(); 
                    uploadStatus.textContent = `Archivo: ${file.name} cargado.`;
                    uploadStatus.classList.remove('hidden', 'text-red-500', 'text-gray-500');
                    uploadStatus.classList.add('text-primary');
                };
                reader.onerror = function() {
                    uploadStatus.textContent = "Error al cargar el archivo.";
                    uploadStatus.classList.remove('hidden', 'text-primary', 'text-gray-500');
                    uploadStatus.classList.add('text-red-500');
                }
                reader.readAsDataURL(file);
            }
        });

        // Función para reiniciar el personalizador
        function resetDesign() {
            // Reiniciar estado
            designState = {
                x: 0,
                y: 0,
                scale: 1,
                designUrl: '',
                isDragging: false,
                initialTouchDistance: null, 
                lastX: 0,
                lastY: 0,
            };

            // Reiniciar DOM
            designOverlay.src = '';
            designOverlay.classList.add('opacity-0');
            designPrompt.classList.remove('hidden');
            interactionGuide.classList.add('hidden');
            
            // Revertir a la vista predeterminada (Camiseta Blanca)
            document.getElementById('colorWhite').checked = true;
            document.querySelector('input[name="productType"][value="Camiseta"]').checked = true;
            
            updateProductView();
            applyDesignTransform();
            
            uploadStatus.textContent = "Vista previa reiniciada.";
            uploadStatus.classList.remove('hidden', 'text-primary', 'text-red-500');
            uploadStatus.classList.add('text-gray-500');
        }

        // Función para mostrar/ocultar la guía de talles
        function toggleSizeGuide() {
            // Se invierte la lógica porque la tabla ahora está abierta por defecto
            const isHidden = sizeGuideTable.style.maxHeight === '0px' || sizeGuideTable.style.maxHeight === '';
            
            if (isHidden) {
                // Abrir
                // NOTA: Usamos scrollHeight + 'px' para asegurar que se abra al tamaño correcto
                sizeGuideTable.style.maxHeight = sizeGuideTable.scrollHeight + "px";
                guideToggleButton.textContent = "Ver Guía de Talles (Cerrar)";
                sizeGuideTable.style.padding = '1rem';
            } else {
                // Cerrar
                sizeGuideTable.style.maxHeight = '0px';
                guideToggleButton.textContent = "Ver Guía de Talles (Abrir)";
                sizeGuideTable.style.padding = '0 1rem'; // Mantener padding horizontal por si acaso
            }
        }
        
        // Función para cerrar la guía sin animar (solo para la carga inicial)
        function closeSizeGuideWithoutAnimation() {
            sizeGuideTable.style.maxHeight = '0px';
            sizeGuideTable.style.padding = '0 1rem';
            guideToggleButton.textContent = "Ver Guía de Talles (Abrir)";
        }
        
        // --- FUNCIÓN CLAVE PARA ENVIAR EL FORMULARIO CON LA IMAGEN ---
        async function submitFormWithDesign(event) {
            event.preventDefault(); // Detener el envío del formulario inmediatamente

            // Deshabilitar botón y mostrar carga
            submitButton.disabled = true;
            submitButton.textContent = "Enviando...";
            loadingStatus.classList.remove('hidden');
            
            try {
                // 1. Capturar el contenedor de la vista previa
                const previewElement = document.getElementById('previewBox');
                
                // 2. Generar el Canvas a partir del HTML
                const canvas = await html2canvas(previewElement, {
                    // Ignorar la capa de texto de ayuda si está visible
                    ignoreElements: (element) => element.id === 'designPrompt',
                    // Asegura que las imágenes se carguen correctamente
                    useCORS: true, 
                    // Escala para mejorar la calidad de la imagen resultante (opcional, pero recomendado)
                    scale: 2, 
                });

                // 3. Convertir el Canvas a una URL de imagen Base64 (JPEG para menor tamaño)
                const imageUrlBase64 = canvas.toDataURL('image/jpeg', 0.9);

                // 4. Llenar el campo oculto con la URL Base64
                designImageUrlInput.value = imageUrlBase64;

                // 5. Llenar los campos ocultos de producto
                const productType = document.querySelector('input[name="productType"]:checked').value;
                const productColor = document.querySelector('input[name="productColor"]:checked').value;
                selectedProductInput.value = `${productType} ${productColor}`;

                if (productType === 'Camiseta') {
                    const shirtSize = document.getElementById('shirtSize').value;
                    selectedSizeColorInput.value = shirtSize;
                } else {
                    selectedSizeColorInput.value = 'N/A'; // No aplica talle para la taza
                }

                // 6. Ahora que los datos están cargados, enviar el formulario de forma nativa
                contactForm.submit();

            } catch (error) {
                console.error("Error al capturar el diseño o enviar el formulario:", error);
                
                // Revertir el estado de carga y habilitar el botón
                submitButton.disabled = false;
                submitButton.textContent = "Enviar Solicitud de Cotización";
                loadingStatus.classList.add('hidden');
                
                // Si falla la captura, enviar de todos modos con un placeholder para no perder los datos del cliente
                if (!designImageUrlInput.value) {
                    designImageUrlInput.value = "ERROR_CAPTURA: Se recomienda contactar por WhatsApp para enviar la imagen.";
                }
                
                // Usar un modal personalizado en lugar de alert()
                showCustomAlert("Ocurrió un error al procesar tu diseño. Se enviarán solo los datos de contacto. Por favor, envía la imagen del diseño por separado a través de WhatsApp.", 'error');

                // Forzar el envío del formulario (para que al menos lleguen los datos de contacto)
                contactForm.submit();
            }
            
            return false; // Prevenimos el envío nativo hasta que el proceso asíncrono termine
        }
        
        // Función de alerta personalizada (Reemplaza a alert() por restricción)
        function showCustomAlert(message, type) {
            // Implementación simple de un modal de mensaje en el DOM, ya que no podemos usar alert()
            let alertBox = document.getElementById('customAlertBox');
            if (!alertBox) {
                alertBox = document.createElement('div');
                alertBox.id = 'customAlertBox';
                alertBox.className = 'fixed top-5 right-5 z-[101] p-4 rounded-lg shadow-2xl transition duration-500 transform scale-0';
                document.body.appendChild(alertBox);
            }

            alertBox.textContent = message;
            alertBox.style.backgroundColor = type === 'error' ? '#EF4444' : '#10B981';
            alertBox.style.color = '#fff';
            
            // Mostrar y luego ocultar
            alertBox.classList.remove('scale-0');
            alertBox.classList.add('scale-100');
            setTimeout(() => {
                alertBox.classList.remove('scale-100');
                alertBox.classList.add('scale-0');
            }, 5000);
        }

        // --- LÓGICA DE INTERACCIÓN (Arrastrar y Escalar) ---
        // (Se movió la lógica de arrastrar/escalar para mantener el código más limpio, pero se mantiene la funcionalidad)
        // [Inicia lógica de Interacción]...

        function getDistance(touches) {
            return Math.sqrt(
                Math.pow(touches[0].pageX - touches[1].pageX, 2) +
                Math.pow(touches[0].pageY - touches[1].pageY, 2)
            );
        }

        designOverlay.addEventListener('mousedown', startDrag);
        designOverlay.addEventListener('touchstart', startDrag, { passive: false });

        function startDrag(e) {
            e.preventDefault();
            if (!designState.designUrl) return;

            designState.isDragging = true;
            
            if (e.touches && e.touches.length > 0) {
                if (e.touches.length === 1) {
                    designState.lastX = e.touches[0].clientX;
                    designState.lastY = e.touches[0].clientY;
                    designState.initialTouchDistance = null; 
                } else if (e.touches.length >= 2) {
                    designState.initialTouchDistance = getDistance(e.touches);
                    designState.lastScale = designState.scale;
                    designState.isDragging = false; 
                }
            } else {
                designState.lastX = e.clientX;
                designState.lastY = e.clientY;
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', endDrag);
            }
        }
        
        designOverlay.addEventListener('touchmove', drag, { passive: false });

        function drag(e) {
            if (!designState.designUrl) return;
            e.preventDefault(); 

            if (e.touches && e.touches.length > 0) {
                if (e.touches.length === 1 && designState.isDragging) {
                    const deltaX = e.touches[0].clientX - designState.lastX;
                    const deltaY = e.touches[0].clientY - designState.lastY;

                    designState.x += deltaX;
                    designState.y += deltaY;

                    designState.lastX = e.touches[0].clientX;
                    designState.lastY = e.touches[0].clientY;
                } else if (e.touches.length >= 2 && designState.initialTouchDistance !== null) {
                    const currentDistance = getDistance(e.touches);
                    const scaleFactor = currentDistance / designState.initialTouchDistance;
                    designState.scale = designState.lastScale * scaleFactor;
                }
            } else if (designState.isDragging) {
                const deltaX = e.clientX - designState.lastX;
                const deltaY = e.clientY - designState.lastY;

                designState.x += deltaX;
                designState.y += deltaY;

                designState.lastX = e.clientX;
                designState.lastY = e.clientY;
            }
            
            clampDesignPosition();
        }

        designOverlay.addEventListener('touchend', endDrag);

        function endDrag(e) {
            designState.isDragging = false;
            designState.initialTouchDistance = null;
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', endDrag);
            clampDesignPosition();
        }

        designOverlay.addEventListener('wheel', function(e) {
            if (!designState.designUrl) return;
            e.preventDefault(); 

            const zoomAmount = e.deltaY > 0 ? -0.1 : 0.1; 
            designState.scale += zoomAmount;
            
            clampDesignPosition(); 
        });

        // [Fin lógica de Interacción]...


        // --- LÓGICA DE INICIALIZACIÓN DEL MAPA ---
        function initializeMap() {
            // Coordenadas para Tarragona (cerca de la T. Arena)
            const tarragonaLat = 41.1166; 
            const tarragonaLng = 1.2500;  
            const zoomLevel = 14;

            const mapElement = document.getElementById('contactMap');
            
            if (typeof L === 'undefined') {
                 mapElement.innerHTML = `
                    <div class="w-full h-full flex items-center justify-center bg-red-100 text-red-700 p-8 text-center">
                        <p class="font-bold text-lg mb-2">¡Error de Mapa!</p>
                        <p>La librería de mapas no se cargó. Esto puede ser por un bloqueo de red. Por favor, recarga la página.</p>
                    </div>
                `;
                console.error("Leaflet library (L) is undefined. Check Leaflet script tag.");
                return;
            }

            try {
                // 1. Inicializa el mapa
                const map = L.map('contactMap').setView([tarragonaLat, tarragonaLng], zoomLevel);

                // 2. Añade la capa de baldosas (tiles) de OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                // 3. Añade un marcador en la ubicación (usamos coordenadas ligeramente más precisas para el centro)
                L.marker([tarragonaLat, tarragonaLng]).addTo(map)
                    .bindPopup('<b>Atelier Print</b><br>Nuestra Ubicación en Tarragona')
                    .openPopup();
                    
                console.log('Mapa Leaflet inicializado en Tarragona.');

            } catch (error) {
                console.error("Error al inicializar el mapa Leaflet:", error);
                 mapElement.innerHTML = `
                    <div class="w-full h-full flex items-center justify-center bg-red-100 text-red-700 p-8 text-center">
                        Hubo un problema al dibujar el mapa. Por favor, verifica tu conexión o la consola del navegador.
                    </div>
                `;
            }
        }


        // Inicializar la vista al cargar
        window.onload = function() {
            updateProductView();
            // Cerrar la guía de talles en la carga para no desbordar el modal
            closeSizeGuideWithoutAnimation(); 
            // Inicializar el mapa
            initializeMap();
        }

        // Lógica para reajustar límites al cambiar el tamaño de la ventana
        window.addEventListener('resize', clampDesignPosition);

    </script>
</body>
</html>
